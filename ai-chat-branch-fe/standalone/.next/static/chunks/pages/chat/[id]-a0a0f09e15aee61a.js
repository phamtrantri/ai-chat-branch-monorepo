(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[688],{7890:(e,t,s)=>{"use strict";s.r(t),s.d(t,{__N_SSP:()=>D,default:()=>I});var r=s(23798),n=s(21462),l=s(64139),a=s(68325),i=s(78130),o=s(45107),c=s(80982),d=s(80162),u=s(56884),m=s(68998);s(42432);var f=s(84102),h=s(77775),x=s(52386),g=s(2179),p=s(55841),v=s(73174),y=s(35267),w=s(74386),b=s(16872),j=s(86353),_=s(25850),N=s(50566);let S={show:!1,x:0,y:0,text:""},k=e=>{let{message:t,selectedMessagesIds:s,startNewQuote:a,resetInput:i,isThinking:o=!1}=e,k=(0,l.useRouter)(),[E,C]=(0,n.useState)(S),{id:T,focus:R}=k.query||{},A=Number(R)===t.id,M=s.has(t.id),L=(0,n.useCallback)(e=>{let t=e.currentTarget;requestAnimationFrame(()=>{let e=window.getSelection();if(!e||e.toString().trim().split(" ").length<3)return void C(S);let s=e.getRangeAt(0).cloneRange().getBoundingClientRect(),r=e.toString(),n=t.getBoundingClientRect(),l=s.left-n.left,a=s.top-n.top-40;requestAnimationFrame(()=>{C({show:!0,x:l,y:a,text:r})})})},[]),P=(0,n.useCallback)(e=>{e.stopPropagation()},[]);(0,n.useEffect)(()=>{let e=e=>{if(E.show){let s=document.getElementById((null==t?void 0:t.id)?"msg-".concat(t.id):"");s&&!s.contains(e.target)&&C(S)}};return E.show&&document.addEventListener("mousedown",e),()=>{document.removeEventListener("mousedown",e)}},[E.show,null==t?void 0:t.id]);let D=(0,n.useMemo)(()=>(0,r.jsx)(c.oz,{components:{code(e){let{children:t,className:s,...n}=e,l=/language-(\w+)/.exec(s||"");return l?(0,r.jsx)(f.A,{PreTag:"div",customStyle:{width:"100%",borderRadius:"8px"},language:l[1],style:h.xJ,children:String(t).replace(/\n$/,"")}):(0,r.jsx)("code",{...n,className:s,children:t})}},rehypePlugins:[d.A],remarkPlugins:[u.A,m.A],children:t.content}),[t.content]),I=(0,n.useMemo)(()=>(0,r.jsx)(c.oz,{components:{code(e){let{children:t,className:s,...n}=e,l=/language-(\w+)/.exec(s||"");return l?(0,r.jsx)(f.A,{PreTag:"div",customStyle:{width:"100%",borderRadius:"8px"},language:l[1],style:h.xJ,children:String(t).replace(/\n$/,"")}):(0,r.jsx)("code",{...n,className:s,children:t})}},rehypePlugins:[d.A],remarkPlugins:[u.A,m.A],children:t.reasoning_summary}),[t.reasoning_summary]);return(0,r.jsxs)("div",{className:"relative flex min-w-full flex-col",id:(null==t?void 0:t.id)?"msg-".concat(t.id):void 0,onMouseUp:L,children:[t.reasoning_summary?(0,r.jsx)(j.D,{className:"flex min-w-full",children:(0,r.jsx)(_.R,{"aria-label":o?"Thinking":"Thoughts",className:"prose dark:prose-invert text-sm min-w-full",classNames:{heading:"cursor-pointer mb-0 ".concat(o?"animate-pulse":""),trigger:"pb-0",content:"dark:text-[#f3f3f3] text-gray-700 py-0"},title:o?"Thinking":"Thoughts",children:(0,r.jsx)("div",{onMouseUp:P,children:I})})}):null,E.show?(0,r.jsx)("div",{className:"absolute z-50",style:{left:E.x,top:E.y},children:(0,r.jsxs)("button",{className:"shadow-md flex items-center justify-center gap-1.5 px-2.5 py-1.5 text-base rounded-full bg-gray-100 dark:bg-[#212121] border-1 border-default-200 dark:border-default-300 font-medium cursor-pointer",onClick:()=>a(t,N.wf.REPLY,E.text),children:[(0,r.jsx)(w.aBh,{className:"w-4.5 h-4.5"}),"Ask Chatbot"]})}):null,(0,r.jsxs)("div",{className:"min-h-8 relative flex w-full flex-col items-start text-start break-words whitespace-normal",role:"group",children:[(0,r.jsx)("div",{className:"prose dark:prose-invert relative max-w-full p-2 ".concat(A?"border-2 border-amber-500":""),children:D}),t.content?(0,r.jsxs)("div",{className:"flex flex-row gap-1 text-xs text-gray-500 dark:text-gray-200 px-2",children:[(0,r.jsxs)("button",{className:"flex items-center gap-1 cursor-pointer hover:opacity-70 transition-all duration-200 bg-gray-100 dark:bg-[#323232D9] px-1 py-0.5 rounded-sm font-medium",type:"button",onClick:()=>a(t,N.wf.NEW_THREAD),children:[(0,r.jsx)(y.BlJ,{className:"w-4 h-4"}),(0,r.jsx)("span",{children:"New thread"})]}),t.child_conversations&&t.child_conversations.length>0?(0,r.jsxs)(x.A,{className:"max-w-[300px]",children:[(0,r.jsx)(g.b,{children:(0,r.jsxs)("button",{className:"flex items-center gap-1 cursor-pointer hover:opacity-70 transition-all duration-200 font-normal bg-gray-100 dark:bg-[#323232D9] px-1 py-0.5 rounded-sm",type:"button",children:[(0,r.jsx)(w.y6Z,{className:"w-4 h-4"}),"Threads"]})}),(0,r.jsx)(p.y,{children:(t.child_conversations||[]).map(e=>(0,r.jsx)(v.Y,{onClick:()=>{k.push("/chat/".concat(e.id)),i()},children:e.name},e.id))})]}):null,(0,r.jsxs)("button",{className:"flex items-center cursor-pointer hover:opacity-70 transition-all duration-200 bg-gray-100 dark:bg-[#323232D9] px-1 py-0.5 rounded-sm font-medium",type:"button",onClick:()=>a(t,N.wf.SELECT),children:[(0,r.jsx)(b.A,{isSelected:M,radius:"sm",size:"sm",onValueChange:()=>a(t,N.wf.SELECT)}),(0,r.jsx)("span",{children:M?"Selected message":"Select message"})]}),A?(0,r.jsx)("button",{className:"flex items-center cursor-pointer hover:opacity-70 transition-all duration-200 bg-gray-100 dark:bg-[#323232D9] px-1 py-0.5 rounded-sm font-medium",type:"button",onClick:()=>{k.replace("/chat/".concat(T))},children:"Stop focus"}):null]}):null]})]})};var E=s(55660),C=s(4349);let T=n.memo(e=>{let{message:t}=e,s=(0,l.useRouter)(),n=async()=>{await s.replace({pathname:s.pathname,query:{...s.query,focus:t.referred_message_id}}),t.referred_message_id&&(0,C.U)(t.referred_message_id)};return(0,r.jsxs)("div",{className:"relative flex max-w-full flex-col gap-1 px-2",id:(null==t?void 0:t.id)?"msg-".concat(t.id):void 0,children:[t.referred_message_content?(0,r.jsxs)("button",{className:"text-sm text-gray-500 dark:text-gray-400 flex items-start text-right justify-end gap-1 cursor-pointer",type:"button",onClick:n,children:[t.referred_message_content,(0,r.jsx)(E.ISd,{className:"w-4.5 h-4.5"})]}):null,(0,r.jsx)("div",{className:"min-h-8 relative flex w-full flex-col items-end gap-2 text-start break-words whitespace-normal",children:(0,r.jsx)("div",{className:"relative max-w-3/4 rounded-[18px] bg-gray-200 dark:bg-[#ffffff1a] p-2",children:(0,r.jsx)("div",{className:"whitespace-pre-wrap",children:t.content})})})]})});var R=s(86981);function A(e){return{id:Date.now(),created_at:new Date().toISOString(),updated_at:new Date().toISOString(),child_conversations:[],num_of_children:0,role:"assistant",conversation_id:0,content:"",reasoning_summary:"",...e}}let M=e=>{var t,s;let{historyMessages:c=[]}=e,d=(0,l.useRouter)(),{id:u,focus:m,agentic_mode:f}=d.query||{},h=(0,n.useRef)(null),x=(0,n.useRef)(!1),g=(0,n.useRef)(null),p=(0,n.useRef)(void 0),[v,y]=(0,n.useState)([]),[w,b]=(0,n.useState)(""),[j,_]=(0,n.useState)(""),[S,E]=(0,n.useState)(!1),[M,L]=(0,n.useState)(),[P,D]=(0,n.useState)(void 0),[I,q]=(0,n.useState)(void 0),[z,H]=(0,n.useState)(new Set([])),[B,O]=(0,n.useState)(0),J=(0,n.useMemo)(()=>[...c,...v],[c,v]),U=Math.ceil((B||0)+((null==(t=h.current)?void 0:t.clientHeight)||0)+20)>=((null==(s=h.current)?void 0:s.scrollHeight)||0),Y=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"smooth",t=h.current;null==t||t.scrollTo({top:t.scrollHeight,behavior:e})},Q=async function(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],s=arguments.length>2?arguments[2]:void 0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},n=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{};if(!e.trim())return;E(!0),t||y([...v,A({conversation_id:Number(u),content:e,role:"user",...r})]);let l="",a="";try{let r=await (0,R.t5)({conversationId:Number(u),userMsg:e.trim(),isNewConversation:t,agenticMode:s,promptMode:P,extraParams:n});if(!r.body)throw Error("ReadableStream not supported in this environment.");g.current=r.body.getReader();let i=new TextDecoder,o=!1;for(;!o;){let{value:e,done:t}=await g.current.read();if(e){let t=i.decode(e,{stream:!0}).split("\n"),s="",r="";for(let e of t)if(e.trim()){let t=JSON.parse(e);"real_content"===t.type?s+=t.content:"reasoning_summary"===t.type&&(r+=t.content),p.current=Number(t.message_id)}l+=s,a+=r,b(l+(l?"|":"")),_(a+(a&&!l?"|":""))}o=t}}catch(e){e instanceof Error&&"AbortError"===e.name?console.log("Stream was cancelled"):console.error("Stream error:",e)}finally{var i;null==(i=g.current)||i.releaseLock(),g.current=null,E(!1),y(e=>[...e,A({id:p.current,content:l,role:"assistant",conversation_id:Number(u),reasoning_summary:a})]),b(""),_("")}},F=async()=>{1!==c.length||"user"!==c[0].role||x.current||(x.current=!0,Q(c[0].content,!0,f))};(0,n.useLayoutEffect)(()=>{h.current&&(h.current.style.visibility="hidden")},[u]),(0,n.useLayoutEffect)(()=>{y([])},[u,f,m]),(0,n.useEffect)(()=>{F(),Y("instant"),h.current&&(h.current.style.visibility="visible")},[u]),(0,n.useEffect)(()=>{!M&&S&&Y()},[v,S]),(0,n.useEffect)(()=>()=>{g.current&&g.current.cancel()},[]),(0,n.useEffect)(()=>{setTimeout(()=>{(0,C.U)(m)},100)},[u,m]);let W=async(e,t)=>{Q(e,!1,t)},X=async(e,t)=>{try{E(!0);let s=await (0,R.cK)(e,null==M?void 0:M.id);d.push("/chat/".concat(s.id).concat(t?"?agentic_mode=".concat(t):"")),L(void 0),y([]),x.current=!1}finally{E(!1)}},$=async(e,t)=>{Q(e,!1,t,{referred_message_id:null==M?void 0:M.id,referred_message_content:I},{referred_message:M,sub_str:null!=I?I:""})},K=()=>{L(void 0)},V=async(e,t)=>{Q(e,!1,t,void 0,{selected_messages:J.filter(e=>z.has(e.id)).map(e=>({content:e.content,role:e.role}))})},Z=(e,t,s)=>{if(L(e),D(t),t!==N.wf.SELECT&&H(new Set([])),t===N.wf.REPLY)q(s);else if(t===N.wf.SELECT){let t=new Set(z);t.has(e.id)?t.delete(e.id):t.add(e.id),t.size<=0&&G(),H(t)}},G=()=>{L(void 0),D(void 0),q(void 0),H(new Set([]))};return(0,r.jsxs)("div",{className:"dark:bg-[#212121e6] relative flex h-full max-w-full flex-1 flex-col gap-3 px-2 py-4 overflow-hidden shrink-0",children:[(0,r.jsx)("div",{ref:h,className:"relative flex flex-col h-full w-full overflow-y-auto mb-10",style:{visibility:"hidden"},onScroll:()=>{var e;O((null==(e=h.current)?void 0:e.scrollTop)||0)},children:(0,r.jsxs)("div",{className:"relative flex flex-col gap-10 h-full max-w-200 w-full mx-auto",children:[J.map(e=>"user"===e.role?(0,r.jsx)(T,{message:e},e.id):(0,r.jsx)(k,{message:e,resetInput:K,selectedMessagesIds:z,startNewQuote:Z},e.id)),S?(0,r.jsxs)("div",{className:"flex flex-col min-w-full",children:[(0,r.jsx)(k,{isThinking:S&&!w,message:A({id:p.current,content:w,reasoning_summary:j,conversation_id:Number(u),role:"assistant"}),resetInput:K,selectedMessagesIds:z,startNewQuote:Z}),w||j?null:(0,r.jsx)(a.o,{className:"self-start",color:"current",size:"md",variant:"dots"})]}):null,(0,r.jsx)("div",{className:"invisible min-h-50",style:S?{minHeight:"calc(100svh - 75px - 225px"}:{},children:"placeholder"})]})}),(0,r.jsxs)("div",{className:"absolute inset-x-0 bottom-5 z-10 flex flex-col gap-2 items-center justify-center w-full px-2",children:[(0,r.jsx)("button",{className:"bg-white dark:bg-[#212121e6] border-1 border-gray-300 dark:border-gray-600 flex items-center justify-center h-9 w-9 min-w-9 min-h-9 rounded-full cursor-pointer p-0 transition-[opacity] duration-200",style:{opacity:U?"0":"100"},type:"button",onClick:()=>Y(),children:(0,r.jsx)(i.Erz,{className:"w-[20px] h-[20px]"})}),(0,r.jsx)("div",{className:"w-full px-2 max-w-200",children:(0,r.jsx)(o.A,{customClassName:"w-full",handleStop:()=>{g.current&&(g.current.cancel(),g.current=null),E(!1),b(""),_("")},handleSubmit:(e,t)=>{P===N.wf.NEW_THREAD?X(e,t):P===N.wf.REPLY?(G(),$(e,t)):P===N.wf.SELECT?(G(),V(e,t)):W(e,t)},isSubmitting:S,quoteMsg:M,quoteType:P,replySubstr:I,selectedMessageIds:z,onCloseQuote:G})})]})]})};var L=s(36025),P=s(50478),D=!0;function I(e){let{conversations:t,history:s}=e;return(0,r.jsx)(P.A,{conversations:t,children:(0,r.jsxs)("div",{className:"relative flex max-w-full h-full flex-1 flex-col",children:[(0,r.jsx)(L.A,{conversations:t,historyMessages:s.messages,path:s.path}),(0,r.jsx)(M,{historyMessages:s.messages})]})})}},63132:(e,t,s)=>{(window.__NEXT_P=window.__NEXT_P||[]).push(["/chat/[id]",function(){return s(7890)}])}},e=>{var t=t=>e(e.s=t);e.O(0,[45,985,113,231,160,927,912,242,395,767,654,923,1,360,636,593,792],()=>t(63132)),_N_E=e.O()}]);