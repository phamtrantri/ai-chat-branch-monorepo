(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[688],{63132:(e,t,s)=>{(window.__NEXT_P=window.__NEXT_P||[]).push(["/chat/[id]",function(){return s(76894)}])},76894:(e,t,s)=>{"use strict";s.r(t),s.d(t,{__N_SSP:()=>Q,default:()=>F});var r=s(23798),l=s(21462),n=s(64139),a=s(31814),i=s(78130),o=s(97367),c=s.n(o),d=s(35031),u=s(80982),m=s(80162),x=s(56884),f=s(68998);s(42432);var g=s(84102),h=s(77775),p=s(15050),v=s(88329),y=s(87979),w=s(24097),b=s(74386),j=s(50349),N=s(21508),_=s(25850),S=s(35364),k=s(21321),E=s(92288),R=s.n(E),T=s(92258),C=s(39290),A=s(95706),M=s(12146);let L=e=>{let{message:t}=e;return!t.model_settings||c()(t.model_settings)?null:1===Object.keys(t.model_settings).length?(0,r.jsx)("div",{className:"flex flex-row gap-1",children:(0,r.jsx)(k.R,{color:"primary",size:"sm",variant:"flat",children:Object.values(t.model_settings)[0]})}):(0,r.jsxs)(T.y,{children:[(0,r.jsx)(C.T,{children:(0,r.jsxs)(k.R,{classNames:{base:"cursor-pointer",content:"flex flex-row items-center justify-center gap-0.5"},color:"primary",size:"sm",variant:"flat",children:["Multiple models",(0,r.jsx)(M.mf,{className:"w-4 h-4"})]})}),(0,r.jsx)(A.C,{children:(0,r.jsx)("div",{className:"flex flex-col gap-2 text-sm",children:Object.entries(t.model_settings).map(e=>{let[t,s]=e;return(0,r.jsxs)("div",{className:"flex flex-row gap-1",children:[(0,r.jsxs)("label",{className:"text-gray-400",children:[R()(t.split("_").join(" ")),":"]}),(0,r.jsx)("span",{children:s})]},t)})})})]})};var P=s(50566);let z={show:!1,x:0,y:0,text:""},I=e=>{var t;let{message:s,selectedMessagesIds:a,startNewQuote:o,resetInput:c,isThinking:d=!1}=e,E=(0,n.useRouter)(),[T,C]=(0,l.useState)(z),{id:A,focus:M}=E.query||{},I=Number(M)===s.id,q=a.has(s.id),D=(0,l.useCallback)(e=>{let t=e.currentTarget;requestAnimationFrame(()=>{let e=window.getSelection();if(!e||e.toString().trim().split(" ").length<3)return void C(z);let s=e.getRangeAt(0).cloneRange().getBoundingClientRect(),r=e.toString(),l=t.getBoundingClientRect(),n=s.left-l.left,a=s.top-l.top-40;requestAnimationFrame(()=>{C({show:!0,x:n,y:a,text:r})})})},[]),O=(0,l.useCallback)(e=>{e.stopPropagation()},[]);(0,l.useEffect)(()=>{let e=e=>{if(T.show){let t=document.getElementById((null==s?void 0:s.id)?"msg-".concat(s.id):"");t&&!t.contains(e.target)&&C(z)}};return T.show&&document.addEventListener("mousedown",e),()=>{document.removeEventListener("mousedown",e)}},[T.show,null==s?void 0:s.id]);let Y=(0,l.useMemo)(()=>(0,r.jsx)(u.oz,{components:{code(e){let{children:t,className:s,...l}=e,n=/language-(\w+)/.exec(s||"");return n?(0,r.jsx)(g.A,{PreTag:"div",customStyle:{width:"100%",borderRadius:"8px"},language:n[1],style:h.xJ,children:String(t).replace(/\n$/,"")}):(0,r.jsx)("code",{...l,className:s,children:t})}},rehypePlugins:[m.A],remarkPlugins:[x.A,f.A],children:s.content}),[s.content]),H=(0,l.useMemo)(()=>(0,r.jsx)(u.oz,{components:{code(e){let{children:t,className:s,...l}=e,n=/language-(\w+)/.exec(s||"");return n?(0,r.jsx)(g.A,{PreTag:"div",customStyle:{width:"100%",borderRadius:"8px"},language:n[1],style:h.xJ,children:String(t).replace(/\n$/,"")}):(0,r.jsx)("code",{...l,className:s,children:t})}},rehypePlugins:[m.A],remarkPlugins:[x.A,f.A],children:s.reasoning_summary}),[s.reasoning_summary]);return(0,r.jsxs)("div",{className:"relative flex min-w-full flex-col",id:(null==s?void 0:s.id)?"msg-".concat(s.id):void 0,onMouseUp:D,children:[(0,r.jsxs)("div",{className:"flex flex-row gap-1",children:[s.agentic_mode?(0,r.jsx)(k.R,{color:"warning",size:"sm",variant:"flat",children:R()(null==(t=s.agentic_mode)?void 0:t.split("_").join(" "))}):null,(0,r.jsx)(L,{message:s})]}),s.reasoning_summary?(0,r.jsx)(N.D,{className:"flex min-w-full",children:(0,r.jsx)(_.R,{"aria-label":d?"Thinking":"Thoughts",className:"prose dark:prose-invert text-sm min-w-full",classNames:{heading:"mb-0 ".concat(d?"animate-pulse":""),trigger:"cursor-pointer pb-0",content:"dark:text-[#f3f3f3] text-gray-700 py-0"},title:d?"Thinking":"Thoughts",children:(0,r.jsx)("div",{onMouseUp:O,children:H})})}):null,T.show?(0,r.jsx)("div",{className:"absolute z-50",style:{left:T.x,top:T.y},children:(0,r.jsxs)("button",{className:"shadow-md flex items-center justify-center gap-1.5 px-2.5 py-1.5 text-base rounded-full bg-gray-100 dark:bg-[#212121] border-1 border-default-200 dark:border-default-300 font-medium cursor-pointer",onClick:()=>o(s,P.wf.REPLY,T.text),children:[(0,r.jsx)(b.aBh,{className:"w-4.5 h-4.5"}),"Ask Chatbot"]})}):null,(0,r.jsxs)("div",{className:"min-h-8 relative flex w-full flex-col items-start text-start break-words whitespace-normal",role:"group",children:[(0,r.jsx)("div",{className:"prose dark:prose-invert relative max-w-full p-2 ".concat(I?"border-2 border-amber-500":""),children:Y}),s.content?(0,r.jsxs)("div",{className:"flex flex-row gap-1 text-xs text-gray-500 dark:text-gray-200 px-2",children:[(0,r.jsxs)("button",{className:"flex items-center gap-1 cursor-pointer hover:opacity-70 transition-all duration-200 bg-gray-100 dark:bg-[#323232D9] px-1 py-0.5 rounded-sm font-medium",type:"button",onClick:()=>o(s,P.wf.NEW_THREAD),children:[(0,r.jsx)(S.McA,{className:"w-4 h-4"}),(0,r.jsx)("span",{children:"New thread"})]}),s.child_conversations&&s.child_conversations.length>0?(0,r.jsxs)(p.A,{className:"max-w-[300px]",children:[(0,r.jsx)(v.b,{children:(0,r.jsxs)("button",{className:"flex items-center gap-1 cursor-pointer hover:opacity-70 transition-all duration-200 font-normal bg-gray-100 dark:bg-[#323232D9] px-1 py-0.5 rounded-sm",type:"button",children:[(0,r.jsx)(b.y6Z,{className:"w-4 h-4"}),"Threads"]})}),(0,r.jsx)(y.y,{children:(s.child_conversations||[]).map(e=>(0,r.jsx)(w.Y,{onClick:()=>{E.push("/chat/".concat(e.id)),c()},children:e.name},e.id))})]}):null,(0,r.jsxs)("button",{className:"flex items-center cursor-pointer hover:opacity-70 transition-all duration-200 bg-gray-100 dark:bg-[#323232D9] px-1 py-0.5 rounded-sm font-medium",type:"button",onClick:()=>o(s,P.wf.SELECT),children:[(0,r.jsx)(j.A,{isSelected:q,radius:"sm",size:"sm",onValueChange:()=>o(s,P.wf.SELECT)}),(0,r.jsx)("span",{children:q?"Selected message":"Select message"})]}),I?(0,r.jsxs)("button",{className:"flex items-center cursor-pointer hover:opacity-70 transition-all duration-200 bg-gray-100 dark:bg-[#323232D9] px-1 py-0.5 rounded-sm font-medium",type:"button",onClick:()=>{E.replace("/chat/".concat(A))},children:[(0,r.jsx)(i.lr4,{className:"w-4 h-4"}),"Stop focus"]}):null]}):null]})]})};var q=s(55660),D=s(4349);let O=l.memo(e=>{let{message:t}=e,s=(0,n.useRouter)(),l=async()=>{await s.replace({pathname:s.pathname,query:{...s.query,focus:t.referred_message_id}}),t.referred_message_id&&(0,D.U)(t.referred_message_id)};return(0,r.jsxs)("div",{className:"relative flex max-w-full flex-col gap-1 px-2",id:(null==t?void 0:t.id)?"msg-".concat(t.id):void 0,children:[t.referred_message_content?(0,r.jsxs)("button",{className:"text-sm text-gray-500 dark:text-gray-400 flex items-start text-right justify-end gap-1 cursor-pointer",type:"button",onClick:l,children:[t.referred_message_content,(0,r.jsx)(q.ISd,{className:"w-4.5 h-4.5"})]}):null,(0,r.jsx)("div",{className:"min-h-8 relative flex w-full flex-col items-end gap-2 text-start break-words whitespace-normal",children:(0,r.jsx)("div",{className:"relative max-w-3/4 rounded-[18px] bg-gray-200 dark:bg-[#ffffff1a] p-2",children:(0,r.jsx)("div",{className:"whitespace-pre-wrap",children:t.content})})})]})});var Y=s(86981),H=s(20059);let B=e=>{var t,s;let{historyMessages:o=[]}=e,u=(0,n.useRouter)(),{id:m,focus:x,agentic_mode:f}=u.query||{},g=(0,l.useRef)(null),h=(0,l.useRef)(!1),p=(0,l.useRef)(null),v=(0,l.useRef)(void 0),y=(0,l.useRef)(void 0),w=(0,l.useRef)(void 0),[b,j]=(0,l.useState)([]),[N,_]=(0,l.useState)(""),[S,k]=(0,l.useState)(""),[E,R]=(0,l.useState)(!1),[T,C]=(0,l.useState)(),[A,M]=(0,l.useState)(void 0),[L,z]=(0,l.useState)(void 0),[q,B]=(0,l.useState)(new Set([])),[J,U]=(0,l.useState)(0),Q=(0,l.useMemo)(()=>[...o,...b],[o,b]),F=Math.ceil((J||0)+((null==(t=g.current)?void 0:t.clientHeight)||0)+20)>=((null==(s=g.current)?void 0:s.scrollHeight)||0),W=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"smooth",t=g.current;null==t||t.scrollTo({top:t.scrollHeight,behavior:e})},X=async function(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],s=arguments.length>2?arguments[2]:void 0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},l=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{};if(!e.trim())return;R(!0),t||j([...b,(0,H.Y)({conversation_id:Number(m),content:e,role:"user",...r})]);let n="",a="";try{let r=JSON.parse(localStorage.getItem(s||"default")||"{}"),i=await (0,Y.t5)({conversationId:Number(m),userMsg:e.trim(),isNewConversation:t,agenticMode:s,promptMode:A,extraParams:l,modelSettings:c()(r)?(0,H.r)({},s):r});if(!i.body)throw Error("ReadableStream not supported in this environment.");p.current=i.body.getReader();let o=new TextDecoder,d=!1;for(;!d;){let{value:e,done:t}=await p.current.read();if(e){let t=o.decode(e,{stream:!0}).split("\n"),s="",r="";for(let e of t)if(e.trim()){let t=JSON.parse(e);"real_content"===t.type?s+=t.content:"reasoning_summary"===t.type&&(r+=t.content),v.current=Number(t.message_id),y.current=t.agentic_mode,w.current=t.model_settings}n+=s,a+=r,_(n+(n?"|":"")),k(a+(a&&!n?"|":""))}d=t}}catch(e){e instanceof Error&&"AbortError"===e.name?console.log("Stream was cancelled"):console.error("Stream error:",e)}finally{var i;null==(i=p.current)||i.releaseLock(),p.current=null,R(!1),j(e=>[...e,(0,H.Y)({id:v.current,content:n,role:"assistant",conversation_id:Number(m),reasoning_summary:a,agentic_mode:y.current,model_settings:w.current})]),_(""),k(""),setTimeout(()=>{y.current=void 0,w.current=void 0,v.current=void 0},100)}},$=async()=>{1!==o.length||"user"!==o[0].role||h.current||(h.current=!0,X(o[0].content,!0,f))};(0,l.useLayoutEffect)(()=>{g.current&&(g.current.style.visibility="hidden")},[m]),(0,l.useLayoutEffect)(()=>{j([])},[m,f,x]),(0,l.useEffect)(()=>{$(),W("instant"),g.current&&(g.current.style.visibility="visible")},[m]),(0,l.useEffect)(()=>{!T&&E&&W()},[b,E]),(0,l.useEffect)(()=>()=>{p.current&&p.current.cancel()},[]),(0,l.useEffect)(()=>{setTimeout(()=>{(0,D.U)(x)},100)},[m,x]);let K=async(e,t)=>{X(e,!1,t)},V=async(e,t)=>{try{R(!0);let s=await (0,Y.cK)(e,null==T?void 0:T.id);u.push("/chat/".concat(s.id).concat(t?"?agentic_mode=".concat(t):"")),C(void 0),j([]),h.current=!1}finally{R(!1)}},Z=async(e,t)=>{X(e,!1,t,{referred_message_id:null==T?void 0:T.id,referred_message_content:L},{referred_message:T,sub_str:null!=L?L:""})},G=()=>{C(void 0)},ee=async(e,t)=>{X(e,!1,t,void 0,{selected_messages:Q.filter(e=>q.has(e.id)).map(e=>({content:e.content,role:e.role}))})},et=(e,t,s)=>{if(C(e),M(t),t!==P.wf.SELECT&&B(new Set([])),t===P.wf.REPLY)z(s);else if(t===P.wf.SELECT){let t=new Set(q);t.has(e.id)?t.delete(e.id):t.add(e.id),t.size<=0&&es(),B(t)}},es=()=>{C(void 0),M(void 0),z(void 0),B(new Set([]))};return(0,r.jsxs)("div",{className:"dark:bg-[#212121e6] relative flex h-full max-w-full flex-1 flex-col gap-3 px-2 py-4 overflow-hidden shrink-0",children:[(0,r.jsx)("div",{ref:g,className:"relative flex flex-col h-full w-full overflow-y-auto mb-10",style:{visibility:"hidden"},onScroll:()=>{var e;U((null==(e=g.current)?void 0:e.scrollTop)||0)},children:(0,r.jsxs)("div",{className:"relative flex flex-col gap-10 h-full max-w-200 w-full mx-auto",children:[Q.map(e=>"user"===e.role?(0,r.jsx)(O,{message:e},e.id):(0,r.jsx)(I,{message:e,resetInput:G,selectedMessagesIds:q,startNewQuote:et},e.id)),E?(0,r.jsxs)("div",{className:"flex flex-col min-w-full",children:[(0,r.jsx)(I,{isThinking:E&&!N,message:(0,H.Y)({id:v.current,content:N,reasoning_summary:S,conversation_id:Number(m),role:"assistant",agentic_mode:y.current,model_settings:w.current}),resetInput:G,selectedMessagesIds:q,startNewQuote:et}),N||S?null:(0,r.jsx)(a.o,{className:"self-start",color:"current",size:"md",variant:"dots"})]}):null,(0,r.jsx)("div",{className:"invisible min-h-50",style:E?{minHeight:"calc(100svh - 75px - 225px"}:{},children:"placeholder"})]})}),(0,r.jsxs)("div",{className:"absolute inset-x-0 bottom-5 z-10 flex flex-col gap-2 items-center justify-center w-full px-2",children:[(0,r.jsx)("button",{className:"bg-white dark:bg-[#212121e6] border-1 border-gray-300 dark:border-gray-600 flex items-center justify-center h-9 w-9 min-w-9 min-h-9 rounded-full cursor-pointer p-0 transition-[opacity] duration-200",style:{opacity:F?"0":"100"},type:"button",onClick:()=>W(),children:(0,r.jsx)(i.Erz,{className:"w-[20px] h-[20px]"})}),(0,r.jsx)("div",{className:"w-full px-2 max-w-200",children:(0,r.jsx)(d.A,{customClassName:"w-full",handleStop:()=>{p.current&&(p.current.cancel(),p.current=null),R(!1),_(""),k("")},handleSubmit:(e,t)=>{A===P.wf.NEW_THREAD?V(e,t):A===P.wf.REPLY?(es(),Z(e,t)):A===P.wf.SELECT?(es(),ee(e,t)):K(e,t)},isSubmitting:E,quoteMsg:T,quoteType:A,replySubstr:L,selectedMessageIds:q,onCloseQuote:es})})]})]})};var J=s(36025),U=s(50478),Q=!0;function F(e){let{conversations:t,history:s}=e;return(0,r.jsx)(U.A,{conversations:t,children:(0,r.jsxs)("div",{className:"relative flex max-w-full h-full flex-1 flex-col",children:[(0,r.jsx)(J.A,{conversations:t,historyMessages:s.messages,path:s.path}),(0,r.jsx)(B,{historyMessages:s.messages})]})})}}},e=>{var t=t=>e(e.s=t);e.O(0,[45,985,113,231,160,927,912,242,395,514,767,654,592,674,284,636,593,792],()=>t(63132)),_N_E=e.O()}]);